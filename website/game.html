<!DOCTYPE html>
<html style="scroll-behavior:smooth">
<head lang="en">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <title>BeatMeIfYouCan.xyz</title>
  <link rel="icon" href="beat-me-if-you-can-logo.png" />
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#fff" />
  <style>
    ul{list-style:none;padding:0;margin:0 0 5px;display:flex;opacity:0}
    li{outline:2px solid #fff4;border-radius:50%;padding:2px 7px;font-size:25px;position:relative;pointer-events:all;margin:0 4px}
    li:hover{background-color:#fff4}
    #map>*,#others>div{pointer-events:none;position:absolute;pointer-events:none;user-select:none}
    .player img{width:32px;height:32px;width:32px;object-fit:cover;object-position:0}
    .player{position:absolute;display:flex;flex-direction:column;align-items:center;transform:translate(-50%,-100%)}
    .name{color:#fffa;text-shadow:1px 1px black;font-weight:bold;margin-bottom:3px}
    button{all:unset;color:#66f;width:100%;text-align:center;padding:12px;box-sizing:border-box;cursor:pointer;width:100%;text-align:center;border-bottom:1px solid #aaa}button:last-child{border-bottom:none}button:hover{background-color:#eee}
    .buttons>div{display:flex}
    .hand{font-size:200%}
    #fight:hover{background-color:#fff6}
    #vs>div{display:inline;font-weight:bold}
    .chat{display:none;font-size:14px;color:#fff;background-color:#000;padding:3px 8px;border-radius:9px;width:max-content;max-width:14em;min-width:3em;overflow:scroll}
    .chat:after{content:'';border-top:5px solid #000;border-left:5px solid #0000;border-right:5px solid #0000;top:23px;left:46%;position:absolute}
  </style>
</head>
<body style="background-color:#44a;font-family:system-ui;font-size:16px">
  <div id="map" style="position:relative;width:1024px;height:512px;background-color:#070;margin:0 auto;cursor:pointer">
    <img id="network" src="image/network-error.svg" style="position:fixed;right:14px;top:11px;width:34px" />
    <div id="others" class="player"></div>
    <div id="you" class="player">
      <div class="chat" contenteditable></div>
      <ul><li>✊</li><li>✋</li><li>✌️</li></ul>
      <img />
      <div class="name"></div>
    </div>
    <div id="vs" style="color:#000;background-color:#fff;border-radius:99px;padding:4px 10px;opacity:0;transition:.15s;position:fixed;top:8px;left:50%;transform:translateX(-50%)"></div>
  </div>
</body>
<script>
// player p{x,y,vx,vy,n:name,c:collision debounce,d:challenge}
const $=s=>document.querySelector(s),$$=s=>document.querySelectorAll(s),D=console.log// util
const w=1024,h=512,d=32// pixels
const a=new Map;let x=w/2|0,y=h/2|0,nx=ny=vx=vy=0,tx=ty=null// players & movement
const u=JSON.parse(localStorage.getItem('u'))||{};u.u||=crypto.randomUUID(),S=_=>localStorage.setItem('u',JSON.stringify(u))// auth/cookie
const em=$('#map'),ey=$('#you'),ec=$('#you .chat')// cached dom elements

// net code
let ws
const add=(i,n,f)=>{
  D('i,n,f=',i,n,f)
  if(a.get(i))return;const e=ey.cloneNode(true);e.id=`p${i}`;e.querySelector('.name').innerText=n;e.querySelector('img').src=`image/avatar/${f}`;$('#others').appendChild(e)
},
connect=_=>{
  D('ws connect u.u=',u.u)
  ws=new WebSocket(`wss://${location.host}/wss/${u.u||crypto.randomUUID()}`)
  D('ws=',ws)
  ws.addEventListener('open',e=>{if(!u?.n){u.n=prompt('Enter your name').replaceAll(' ','-');S()};send(`j ${x} ${y} ${nx} ${ny} ${u.n} ${u.a}`)},{passive:true})
  ws.addEventListener('message',e=>{
    const d=e.data,f=d.split(' '),i=parseInt(f[0]),p=a.get(i)
    switch(f[1]){
      case'j':send(`n ${x} ${y} ${nx} ${ny} ${u.n} ${u.a}`);add(i,f[6],f[7]);a.set(i,{...a.get(i),x:parseInt(f[2]),y:parseInt(f[3]),vx:parseInt(f[4]),vy:parseInt(f[5]),n:f[6]});break// join
      case'c':p.d++;break// challenge
      case'n':add(i,f[6],f[7]);a.set(i,{...a.get(i),x:parseInt(f[2]),y:parseInt(f[3]),vx:parseInt(f[4]),vy:parseInt(f[5]),n:f[6]});break// name
      case'm':const l=$(`#p${i} .chat`);l.innerText=d.substr(d.indexOf('m')+2);l.style.display=l.innerText?'block':'none';break// message
      default:add(i);a.set(i,{...a.get(i),x:parseInt(f[1]),y:parseInt(f[2]),vx:parseInt(f[3]),vy:parseInt(f[4])})// move
    }
  },{passive:true})
},send=m=>ws.OPEN==ws.readyState?ws.send(m):ws.CLOSED==ws.readyState?connect():0;connect()// send or reconnect
setInterval(_=>$('#network').style.display=ws.OPEN==ws.readyState?'none':'block',1e3)
setInterval(_=>ws.CLOSED==ws.readyState?connect():0,1e4)// keep alive every 10s

// input - keyboard
let k=[],m=false// mode false=play,true=chat
onkeydown=e=>{if('Enter'==e.key){!m&&ec.innerText.length>0?ec.innerText='':m=!m,!m?send(`m ${ec.innerText}`):0}m?(ec.focus()):e.repeat?0:(tx=ty=0,k.push(e.key));ec.style.display=(m||ec.innerText.length)?'block':'none';ec.contentEditable=m}
onkeyup=e=>{m?0:nx=ny=0,delete k[k.indexOf(e.key)],k=k.filter(e=>e)}
// input - mouse/touch
const v=(x,y)=>[tx,ty]=[x|0,y|0]
em.addEventListener('click',e=>{D('mousedown e=',e);v(e.offsetX,e.offsetY);e.preventDefault();e.stopPropagation();return false},{passive:false,capture:false})
em.addEventListener('touchstart',e=>{D('touchstart e=',e);e=e.touches[0];v(e.offsetX,e.offsetY)},{passive:true,capture:false})
// $('#fight').addEventListener('click',e=>{D('click e=',e);e.preventDefault();e.stopPropagation();return false},{capture:false})

// fight
let hd;setInterval(_=>{let hi,d,c=Infinity;a.forEach((p,i)=>{d=Math.hypot(p.x-x,p.y-y);if(d<c)c=d,hd=d,hi=i});if(hi)$('#vs').innerHTML=`<div>${u.n}</div> vs <div>${a.get(hi).n}</div>`},100)

// animation
const r=(e,x,y,vx,vy)=>{e.style.left=`${x}px`;e.style.top=`${y}px`;e.querySelector('img').style.objectPosition=`-${(0==vx?[6,0,0][vy+1]:[3,0,9][vx+1])*32}px`}//;e.querySelector('.chat').style.display=e.querySelector('.chat').innerText.length?'none':'block'
u.a=(new URL(location)).searchParams.get('avatar')||u.a||'christmas-snowman-black.png';S()
$('#you img').src=`image/avatar/${u.a}`
$('#you .name').innerText=u.n
const eps=1e3/240;let e=Date.now()/eps
requestAnimationFrame(function f(){
  // evolve
  while(e<Date.now()/eps){
    //   character keyboard movement
    switch(k[k.length-1]){case'a':nx=-1;ny=0;break;case's':nx=0;ny=1;break;case'd':nx=1;ny=0;break;case'w':nx=0;ny=-1}
    //   character mouse movement
    if(tx&&tx!=x){nx=Math.sign(tx-x);ny=0}else if(ty&&ty!=y){nx=0;ny=Math.sign(ty-y)};if(tx==x&&ty==y){tx=ty=null,nx=ny=0}
    //   net code
    if(vx!=nx||vy!=ny)send(`${x} ${y} ${nx} ${ny}`),vx=nx,vy=ny
    //   character render
    x+=vx;y+=vy;x&=1023;y&=511
    a.forEach((p,i)=>{
      p.x+=p.vx;p.y+=p.vy;p.x&=1023
      x>p.x-d&x<p.x+d&y>p.y-d&y<p.y+d?(p.c?0:(b=i/*,o=p*/),p.c=true):(p.c=false,p.d=0)//p.c=collision debounce, p.d=challenge counter
    })
    e++
  }

  // render players
  r(ey,x,y,vx,vy);a.forEach((p,i)=>r($(`#p${i}`),p.x,p.y,p.vx,p.vy))
  // render fight
  const vs=hd<128?1:0
  // vs?document.getAnimations()[0].play():document.getAnimations()[0].pause()
  // $('#vs').style.opacity=vs
  // $('#you>ul').style.opacity=vs
  // if(hi){
  //   $('#vs').innerText=`${u.n} vs ${a.get(hi).n}`
  //   $(`#others p${hi}`).style.border='2px solid #fff4'
  // //   // D(a,hi,a.get(hi))
  // //   $('#vs').style.left=`${(x+a.get(hi).x)/2}px`
  // //   $('#vs').style.top=`${(y+a.get(hi).y)/2}px`
  // }
  // scrollTo(x,y)

  // next frame
  requestAnimationFrame(f)
})
</script>
</html>