<html>
<head>
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
</head>
<body>
  <canvas style="width:1024px;height:1024px"></canvas>
</body>
<script>
const $=s=>document.querySelector(s),$$=s=>document.querySelectorAll(s),D=console.log
const c=$('canvas').getContext('2d');w=c.canvas.width=window.innerWidth;h=c.canvas.height=window.innerHeight
const a=new Map,d=10
let x=w/2|0,y=h/2|0,nx=ny=vx=vy=0,tx=ty=null,k=[],u=JSON.parse(localStorage.getItem('u'))||{}

// net code
const ws=new WebSocket(`wss://${location.host}/wss`)
ws.addEventListener('message',e=>{
  D('e=',e)
  e=e.data.split(' ')
  const i=parseInt(e[0]),p=a.get(i)
  if(!p)ws.send(`n ${x} ${y} ${nx} ${ny} ${u.n}`)
  a.set(i,{...p,...'n'==e[1]?{x:parseInt(e[2]),y:parseInt(e[3]),vx:parseInt(e[4]),vy:parseInt(e[5]),n:e[6]}:{x:parseInt(e[1]),y:parseInt(e[2]),vx:parseInt(e[3]),vy:parseInt(e[4])}})
})

// keyboard movement
onkeydown=e=>{if(e.repeat)return;tx=ty=0;k.push(e.key);if('q'==e.key)w.close()}
onkeyup=e=>{nx=ny=0;delete k[k.indexOf(e.key)];k=k.filter(e=>e)}

// mouse/touch movement
onmousedown=e=>{tx=e.clientX|0;ty=e.clientY|0}
ontouchstart=e=>{e=e.touches[0];tx=e.clientX|0;ty=e.clientY|0}

const r=(x,y,n)=>{c.fillStyle='#000';c.fillRect(x,y,d,d);c.fillText(n,x+d+3,y+d)}
requestAnimationFrame(function f(){
  // background
  c.fillStyle='#090';c.fillRect(0,0,c.canvas.width,c.canvas.height)

  // character keyboard movement
  switch(k[k.length-1]){case'a':nx=-1;ny=0;break;case's':nx=0;ny=1;break;case'd':nx=1;ny=0;break;case'w':nx=0;ny=-1}
  // character mouse movement
  if(tx&&tx!=x){nx=Math.sign(tx-x);ny=0}else if(ty&&ty!=y){nx=0;ny=Math.sign(ty-y)};if(tx==x&&ty==y){tx=ty=null,nx=ny=0}
  // net code
  if(vx!=nx||vy!=ny){if(w.OPEN==w.readyState)ws.send(`${x} ${y} ${nx} ${ny}`),vx=nx,vy=ny}
  // character render
  x+=vx;y+=vy;x&=1023;y&=1023;r(x,y,u.n)

  a.forEach((p,i)=>{
    D('p=',p)
    p.x+=p.vx;p.y+=p.vy;p.x&=1023;r(p.x,p.y,i+' '+p.n)
  })

  // next frame
  requestAnimationFrame(f)
})

ws.addEventListener('open',e=>{
  if(!u?.n){u.n=prompt('Enter your name');localStorage.setItem('u',JSON.stringify(u))}
  ws.send(`n ${x} ${y} ${nx} ${ny} ${u.n}`)
})
</script>
</html>