<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>BeatMeIfYouCan.xyz</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="icon" href="beat-me-if-you-can-logo.png">
<style>
:root{--0:#090a06;--1:#3c3c3c;--2:#bbb;--3:#fff}
html{background-color:#222;color:var(--2)}
body{border-collapse:collapse}
section{background-color:#000;border-radius:1em;padding:1em 2em 2em;display:flex;flex-direction:column;margin-bottom:30px;width:fit-content;font-family:monospace;font-size:14px}
h1,h2{color:var(--3);font-family:sans-serif}
h1{font-size:350%;font-family:'Neon Pixel-7';font-weight:normal}
h1 span:nth-child(2n){color:#ff928a}
h1 span:nth-child(2n+1){color:#38b3ff}
h2{font-size:120%;text-transform:uppercase}
p{margin:0 0 1em}
.match{text-align:center}
.match ul{display:table-row;padding:0;margin:0}
.match ul:first-child{font-weight:bold}
.match li{display:table-cell;padding:6px 9px}
.match ul:hover{background-color:#222}
.match ul:first-child:hover{background-color:inherit}
button{border:2px solid;border-color:inherit;background-color:#222;color:#777;border-radius:9px;line-height:26px;padding:0 11px;text-transform:uppercase}
button:hover{filter:brightness(2);box-shadow:0 0 13px 0 #444}
input{width:5em;margin-right:6px;background-color:#023;border:1px solid;border-color:inherit;height:21px;color:#8ef;padding:4px 7px}
.p1,.p2{color:#a47437;white-space:nowrap}.p1{filter:hue-rotate(306deg)}.p2{filter:hue-rotate(175deg)}
input{background-color:#320;color:#c70}
.pill{margin-right:6px;background-color:var(--1);padding:4px 8px;border-radius:9px}
</style>
</head>

<body style="margin:1em;display:flex;justify-content:center">
  <img src="beat-me-if-you-can-logo.png" style="position:fixed;opacity:0.01;width:100%;pointer-events:none">
  <div style="width:100%;max-width:1100px">

    <nav style="display:flex;justify-content:space-between;align-items:center;position:relative">
      <div style="display:flex;align-items:center">
        <img src="beat-me-if-you-can-logo.png" alt="BeatMeIfYouCan.xys Logo" style="height:80px;margin-right:7px"/>
        <h1><span>Beat</span><span>Me</span><span>If</span><span>You</span><span>Can</span><span style="font-size:60%">.xyz</span></h1>
      </div>
      <div>
        <button id="login" style="display:none">Connect</button>
        <div id="logout-container" style="display:flex;align-items:center">
          <div id="balance" class="pill" style="margin-right:6px"></div>
          <div id="address" class="pill" style="margin-right:6px"></div>
          <button id="logout">Disconnect</button>
        </div>
      </div>
    </nav>

    <section>
      <h2>How to Play</h2>
      <p>
        This is a classic game of Rock-Paper-Scissors that can be played against other player on the blockchain.
      </p>
      <p>
        Game progress through 3 stages. First the players submit their encrypted moves to the blockchain. Once the encrypted moves are safetly stored on the blockchain they can be revealed by sending the unencrypted moves and the move encryption keys. Once both players have revealed the smart contract will determine the winner according to the classic rules or Rock-Paper-Scissors and send any bet amount to the winning player.
      <p>
        The quickest way to get started is to close some matches in the "Close a Match" section.
        You can also open a match in the "Open a Match" section, in which case you will need to wait for a challenger to close your match with their moves.
      </p>
    </section>

    <section style="display:none">
      <h2>Waiting for You</h2>
      Matches waiting for you to reveal your move
      <div id="yours-waiting"></div>
    </section>

    <section>
      <h2>Open a Match</h2>
      <div id="open-match">Player 1 Moves <input class="moves p1" maxlength="6" />Bet <input />CRO <button>Open Match</button></div>
    </section>

    <section>
      <h2>Close a Match</h2>
      To close a match:
      <ol>
        <li>Enter 6 Rock/Scissor/Paper moves in the "Your Moves" area by hitting the R,P,S keys</li>
        <li>Hit the "Fight!" button</li>
        <li>Sign your transaction using your crypto wallet (such as MetaMask)</li>
      </ol>
      <div class="match" id="open"></div>
    </section>

    <section>
      <h2>Matches Waiting</h2>
      <div class="match" id="waiting"></div>
    </section>

    <section>
      <h2>Past Matches</h2>
      <div class="match" id="closed"></div>
    </section>

  </div>
  <script src="./js/lib/moralis.min.js"></script>
<script type="module">
  import{CONTRACT as C}from'./js/contract.js';import{ethers as E}from'./js/lib/ethers-5.6.esm.min.js';const U=E.utils
  const $=s=>document.querySelector(s),$$=s=>document.querySelectorAll(s),D=console.log,c=(a,b)=>a.toLowerCase()==b.toLowerCase(),a=(a,b)=>!b&&u?.get('ethAddress').toLowerCase()==a.toLowerCase()?'<div class="you">You</div>':a.slice(0,5)+'&hellip;'+a.slice(-5),s=s=>s>1?'s':'',t=t=>{t=(Date.now()-t*1e3)/1e3/60;return (t>1440?`${t=t/1440|0} day${s(t)}`:t>60?`${t=t/60|0} hour${s(t)}`:`${t=t|0} minute${s(t)}`)+' ago'},b=w=>new Intl.NumberFormat(navigator.locale,{maximumSignificantDigits:3}).format(w/1e18)+' CRO',m=n=>{let s='';for(let i=6;i--;)s+=`&#999${4+(n&3)};`,n>>=2;return s},w=(m1,m2)=>{let s=0;for(let i=6;i--;){let p1=m1&3,p2=m2&3;if(p1!=p2){s+=p1==(p2+1)%3?1:-1};m1>>=2;m2>>=2};return s},v=s=>{let v;for(let c of s){v<<=2;v+='RPS'.indexOf(c)}return U.hexValue(v).slice(2).padStart(4,'0')}
  const serverUrl='https://zwrgre5eepkc.usemoralis.com:2053/server',appId='l4EzyzLJgdwedW9y0Yjr7zV3ZJJQ6OWUp4guuUr3',M=Moralis,G=M.Object.extend('Game'),f=(f,p)=>M.executeFunction({contractAddress:C.address,functionName:f,abi:C.abi,params:p}),Z='0x0000000000000000000000000000000000000000',N='65535'

  let u,r

  await M.start({serverUrl,appId});M.enableWeb3()

  $('#login').addEventListener('click',async()=>{
    u=M.User.current()
    if(!u)u=await M.authenticate({signingMessage:'Connect with beatmeifyoucan.xyz'})
    refresh()
  })
  $('#logout').addEventListener('click',async()=>{await M.User.logOut();refresh()})
  $('#open-match button').addEventListener('click',async()=>{
    // let v;for(let c of $('#open-match input').value){v<<=2;v+='RPS'.indexOf(c)}v=U.hexValue(v).slice(2).padStart(4,'0')
    let v=v($('#open-match input').value)
    let s=U.hexValue(crypto.getRandomValues(new Uint8Array(18)))
    D('0x'+v+s.slice(2))
    f('open',{encryptedMoves:U.keccak256('0x'+v+s.slice(2)),targetPlayer:Z})
  })

  if('loading'!=document.readyState){refresh()}else document.addEventListener('DOMContentLoaded',refresh)
  async function refresh(){
    let e
    u=M?M.User.current():null
    $('#login').style.display=u?'none':'block'
    $('#logout-container').style.display=u?'flex':'none'
    if(u){
      $('#balance').innerText=b((await M.Web3API.account.getNativeBalance()).balance)
      e=u.get('ethAddress')
      $('#address').innerHTML=a(e,true)
      e=e.toLowerCase()
    }

    r=await(new M.Query(G)).equalTo('a2',Z).notEqualTo('a1',e).descending('t').find()
    $('#open').innerHTML='<ul><li>Match</li><li>Time</li><li>Player 1</li><li>Bet</li><li>Player 2 Moves (R,P,S)</li></ul>'+r.map(g=>`<ul><li>${g.get('n')}</li><li>${t(g.get('t'))}</li><li>${a(g.get('a1'))}</li><li>${b(g.get('b'))}</li><li class="p2"><input class="moves" maxlength="6" /><button data-fight="${g.get('n')}">Fight!</button></li></ul>`).join('')
    setInterval(()=>{$$('.moves').forEach(e=>e.value=e.value.toUpperCase().split('').filter(c=>'RPS'.includes(c)).join(''))},100)
    $$('button[data-fight]').forEach(b=>b.addEventListener('click',e=>{
      let t=e.target,m=t.previousSibling.value
      if(6==m.length){
        let o=v(m)
        let s=U.hexValue(crypto.getRandomValues(new Uint8Array(18)))
        D('0x'+o+s.slice(2))
        f('close',{n:t.getAttribute('data-fight'),encryptedMoves:U.keccak256('0x'+o+s.slice(2))})
      }
    }))

    r=await(M.Query.or(
    (new M.Query(G)).notEqualTo('a1',Z).notEqualTo('a2',Z).equalTo('m1',N),
    (new M.Query(G)).notEqualTo('a1',Z).notEqualTo('a2',Z).equalTo('m2',N)
    )).descending('t').find()
    $('#waiting').innerHTML='<ul><li>Match</li><li>Time</li><li>Player 1</li><li>Player 2</li><li>Player 1 Moves</li><li>Player 2 Moves</li><li>Bet</li><li></li></ul>'+r.map(g=>{let m1=g.get('m1'),m2=g.get('m2'),p=w(m1,m2);return `<ul><li>${g.get('n')}</li><li>${t(g.get('t'))}</li><li>${a(g.get('a1'))}</li><li>${a(g.get('a2'))}</li><li class="p1">${N==m1?'?':m(m1)}</li><li class="p2">${N==m2?'?':m(m2)}</li><li>${b(g.get('b'))}</li><li>${c(e,g.get('a1'))&&N==m1||c(e,g.get('a2'))&&N==m2?'<button>Reveal</button>':''}</li><li>${N==m1&&N==m2?'<button>Cancel</button>':''}</li></ul>`}).join('')

    r=await(new M.Query(G)).notEqualTo('a2',Z).notEqualTo('m1',N).notEqualTo('m2',N).descending('t').find()
    $('#closed').innerHTML='<ul><li>Match</li><li>Time</li><li>Player 1</li><li>Player 2</li><li>Player 1 Moves</li><li>Player 2 Moves</li><li>Winnings</li></ul>'+r.map(g=>{let m1=g.get('m1'),m2=g.get('m2'),p=w(m1,m2);return `<ul><li>${g.get('n')}</li><li>${t(g.get('t'))}</li><li>${a(g.get('a1'))}</li><li>${a(g.get('a2'))}</li><li class="p1">${m(m1)}</li><li class="p2">${m(m2)}</li><li>${0==p?'':p>0?'P1':'P2'+' won '+b(g.get('b'))}</li></ul>`}).join('')
  }
</script>
</body>